<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Tutorial on how to setup a node.js application behind nginx | Leonardo Lazzaro</title>
<meta name=keywords content>
<meta name=description content="Introduction Node.js is a JavaScript runtime built on Chrome V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient. NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server.
In this brief tutorial we will setup how to configure a small production application that will use nginx as a reverse proxy for serving the node.js application. For managing node.">
<meta name=author content>
<link rel=canonical href=https://www.lazzaro.com.ar/post/2016-10-14-setup-nodejs-with-nginx/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.lazzaro.com.ar/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://www.lazzaro.com.ar/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.lazzaro.com.ar/favicon-32x32.png>
<link rel=apple-touch-icon href=https://www.lazzaro.com.ar/apple-touch-icon.png>
<link rel=mask-icon href=https://www.lazzaro.com.ar/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Tutorial on how to setup a node.js application behind nginx">
<meta property="og:description" content="Introduction Node.js is a JavaScript runtime built on Chrome V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient. NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server.
In this brief tutorial we will setup how to configure a small production application that will use nginx as a reverse proxy for serving the node.js application. For managing node.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.lazzaro.com.ar/post/2016-10-14-setup-nodejs-with-nginx/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2016-10-14T00:00:00+00:00">
<meta property="article:modified_time" content="2016-10-14T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Tutorial on how to setup a node.js application behind nginx">
<meta name=twitter:description content="Introduction Node.js is a JavaScript runtime built on Chrome V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient. NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server.
In this brief tutorial we will setup how to configure a small production application that will use nginx as a reverse proxy for serving the node.js application. For managing node.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.lazzaro.com.ar/post/"},{"@type":"ListItem","position":3,"name":"Tutorial on how to setup a node.js application behind nginx","item":"https://www.lazzaro.com.ar/post/2016-10-14-setup-nodejs-with-nginx/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tutorial on how to setup a node.js application behind nginx","name":"Tutorial on how to setup a node.js application behind nginx","description":"Introduction Node.js is a JavaScript runtime built on Chrome V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient. NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server.\nIn this brief tutorial we will setup how to configure a small production application that will use nginx as a reverse proxy for serving the node.js application. For managing node.","keywords":[],"articleBody":"Introduction Node.js is a JavaScript runtime built on Chrome V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient. NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server.\nIn this brief tutorial we will setup how to configure a small production application that will use nginx as a reverse proxy for serving the node.js application. For managing node.js application we will use PM2.\nRequirements In the next steps we are going to install node.js in the /opt directory. Check the node version on the url, if this blog post becames old you can change the version on the url.\ncd ~ wget https://nodejs.org/dist/v4.2.3/node-v4.2.3-linux-x64.tar.gz mkdir node tar xvf node-v*.tar.?z --strip-components=1 -C ./node cd ~ rm -rf node-v* mkdir node/etc echo 'prefix=/usr/local'  node/etc/npmrc sudo mv node /opt/ sudo chown -R root: /opt/node sudo ln -s /opt/node/bin/node /usr/local/bin/node sudo ln -s /opt/node/bin/npm /usr/local/bin/npm sudo npm install pm2 -g Add the user for execute the node.js application\nsudo adduser nodejs_app_username Deamonize node.js application We need to deamonize our node.js process to allow it to be restarted automatically if the application crashes or is killed. For this purpose we are going to use PM2, which is a node.js process manager for node.js applications.\nThe startup subcommand generates and configures a startup script to launch PM2 and its managed processes on server boots\nsudo pm2 startup systemd if you are using ubuntu try to use “ubuntu” instead systemd.\nIn my case I was trying to configure a keystone.js project, so I started it with this command (start it with the nodejs app unix user):\nsudo su nodejs_application_username pm2 start keystone.js you should see your process in the list of PM2.\nCheck that the node.js process is working with (change the port if necessary):\nwget http://localhost:3000/ if for some reason your app is not working check the subcommand logs\npm2 logs Nginx configuration We will use nginx as a reverse proxy. This tutorial required nginx already installed, so we are going directly to site configuration. Also this tutorial assumes that your are using the “sites-available” and “sites-enables” to configure more than one domain.\nAdd a new file to /etc/nginx/sites-available with the following:\nupstream nodejs_app_server { # fail_timeout=0 means we always retry an upstream even if it failed # to return a good HTTP response (in case the Unicorn master nukes a # single worker for timing out). server 127.0.0.1:3000 fail_timeout=0; } server { listen 80; server_name www.yourdomain.com; location / { proxy_pass http://nodejs_app_server; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection 'upgrade'; proxy_set_header Host $host; proxy_cache_bypass $http_upgrade; } access_log /var/log/nginx/nodejs_app-access.log; error_log /var/log/nginx/nodejs_app-error.log; } service nginx restart ","wordCount":"443","inLanguage":"en","datePublished":"2016-10-14T00:00:00Z","dateModified":"2016-10-14T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.lazzaro.com.ar/post/2016-10-14-setup-nodejs-with-nginx/"},"publisher":{"@type":"Organization","name":"Leonardo Lazzaro","logo":{"@type":"ImageObject","url":"https://www.lazzaro.com.ar/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://www.lazzaro.com.ar accesskey=h title="Leonardo Lazzaro (Alt + H)">Leonardo Lazzaro</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://www.lazzaro.com.ar/ title=Home>
<span>Home</span>
</a>
</li>
<li>
<a href=https://www.lazzaro.com.ar/post/ title=Archives>
<span>Archives</span>
</a>
</li>
<li>
<a href=https://www.lazzaro.com.ar/about/ title=About>
<span>About</span>
</a>
</li>
<li>
<a href=https://www.lazzaro.com.ar/photography/ title=Photography>
<span>Photography</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Tutorial on how to setup a node.js application behind nginx
</h1>
<div class=post-meta><span title="2016-10-14 00:00:00 +0000 UTC">2016-10-14</span>
</div>
</header>
<div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2>
<p>Node.js is a JavaScript runtime built on Chrome V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient.
NGINX is a free, open-source, high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxy server.</p>
<p>In this brief tutorial we will setup how to configure a small production application that will use nginx as a reverse proxy for serving the node.js application.
For managing node.js application we will use PM2.</p>
<h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2>
<p>In the next steps we are going to install node.js in the /opt directory.
Check the node version on the url, if this blog post becames old you can change the version on the url.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~
wget https://nodejs.org/dist/v4.2.3/node-v4.2.3-linux-x64.tar.gz
mkdir node
tar xvf node-v*.tar.?z --strip-components<span class=o>=</span><span class=m>1</span> -C ./node
<span class=nb>cd</span> ~
rm -rf node-v*
mkdir node/etc
<span class=nb>echo</span> <span class=s1>&#39;prefix=/usr/local&#39;</span> &gt; node/etc/npmrc
sudo mv node /opt/
sudo chown -R root: /opt/node
sudo ln -s /opt/node/bin/node /usr/local/bin/node
sudo ln -s /opt/node/bin/npm /usr/local/bin/npm
sudo npm install pm2 -g</code></pre></div>
<p>Add the user for execute the node.js application</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo adduser nodejs_app_username</code></pre></div>
<h2 id=deamonize-nodejs-application>Deamonize node.js application<a hidden class=anchor aria-hidden=true href=#deamonize-nodejs-application>#</a></h2>
<p>We need to deamonize our node.js process to allow it to be restarted automatically if the application crashes or is killed.
For this purpose we are going to use PM2, which is a node.js process manager for node.js applications.</p>
<p>The startup subcommand generates and configures a startup script to launch PM2 and its managed processes on server boots</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo pm2 startup systemd</code></pre></div>
<p>if you are using ubuntu try to use &ldquo;ubuntu&rdquo; instead systemd.</p>
<p>In my case I was trying to configure a keystone.js project, so I started it with this command (start it with the nodejs app unix user):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo su nodejs_application_username
pm2 start keystone.js</code></pre></div>
<p>you should see your process in the list of PM2.</p>
<p>Check that the node.js process is working with (change the port if necessary):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>wget http://localhost:3000/</code></pre></div>
<p>if for some reason your app is not working check the subcommand logs</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>pm2 logs</code></pre></div>
<h2 id=nginx-configuration>Nginx configuration<a hidden class=anchor aria-hidden=true href=#nginx-configuration>#</a></h2>
<p>We will use nginx as a reverse proxy. This tutorial required nginx already installed, so we are going directly to site configuration.
Also this tutorial assumes that your are using the &ldquo;sites-available&rdquo; and &ldquo;sites-enables&rdquo; to configure more than one domain.</p>
<p>Add a new file to /etc/nginx/sites-available with the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>upstream nodejs_app_server <span class=o>{</span>
  <span class=c1># fail_timeout=0 means we always retry an upstream even if it failed</span>
  <span class=c1># to return a good HTTP response (in case the Unicorn master nukes a</span>
  <span class=c1># single worker for timing out).</span>
  server 127.0.0.1:3000 <span class=nv>fail_timeout</span><span class=o>=</span>0<span class=p>;</span>
<span class=o>}</span>

server <span class=o>{</span>
    listen   80<span class=p>;</span>
    server_name www.yourdomain.com<span class=p>;</span>

    location / <span class=o>{</span>
        proxy_pass http://nodejs_app_server<span class=p>;</span>
        proxy_http_version 1.1<span class=p>;</span>
        proxy_set_header Upgrade <span class=nv>$http_upgrade</span><span class=p>;</span>
        proxy_set_header Connection <span class=s1>&#39;upgrade&#39;</span><span class=p>;</span>
        proxy_set_header Host <span class=nv>$host</span><span class=p>;</span>
        proxy_cache_bypass <span class=nv>$http_upgrade</span><span class=p>;</span>
    <span class=o>}</span>
    access_log /var/log/nginx/nodejs_app-access.log<span class=p>;</span>
    error_log /var/log/nginx/nodejs_app-error.log<span class=p>;</span>
<span class=o>}</span></code></pre></div>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>    service nginx restart</code></pre></div>
</div>
<footer class=post-footer>
</footer>
</article>
</main>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>